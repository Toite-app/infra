# VPS Pull & Restart Pipeline
#
# This workflow pulls latest Docker images and recreates containers on a VPS
# It is triggered manually via workflow_dispatch with environment selection
#
# Prerequisites:
#   - Initial deployment must be completed via deploy.yml (~/app must exist)
#
# Required GitHub Configuration (per environment):
#   Secrets:
#     - VPS_SSH_PRIVATE_KEY: SSH private key for deploy user
#     - VPS_HOST: VPS IP address or hostname
#     - VPS_PORT: SSH port number
#   Variables:
#     - DOMAIN: Domain name for the deployment

name: Pull & Restart Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - dev
          - demo

# Minimal permissions - only read access to repository contents
permissions:
  contents: read

# Prevent simultaneous deployments to the same environment
# Shares concurrency group with deploy.yml
concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  pull:
    name: Pull & Restart ${{ inputs.environment }}
    runs-on: ubuntu-latest

    environment:
      name: ${{ inputs.environment }}
      url: https://${{ vars.DOMAIN }}

    env:
      SSH_OPTS: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ secrets.VPS_PORT }}"

    steps:
      - name: Validate required secrets and variables
        run: |
          set -e
          
          echo "=== Validating required configuration ==="
          
          MISSING=""
          
          # Check secrets (we can only check if they're empty, not if they exist)
          if [[ -z "${{ secrets.VPS_HOST }}" ]]; then
            MISSING="${MISSING}  - VPS_HOST (secret)\n"
          fi
          
          if [[ -z "${{ secrets.VPS_PORT }}" ]]; then
            MISSING="${MISSING}  - VPS_PORT (secret)\n"
          fi
          
          if [[ -z "${{ secrets.VPS_SSH_PRIVATE_KEY }}" ]]; then
            MISSING="${MISSING}  - VPS_SSH_PRIVATE_KEY (secret)\n"
          fi
          
          # Check variables
          if [[ -z "${{ vars.DOMAIN }}" ]]; then
            MISSING="${MISSING}  - DOMAIN (variable)\n"
          fi
          
          if [[ -n "$MISSING" ]]; then
            echo "ERROR: Missing required configuration for environment '${{ inputs.environment }}':"
            echo -e "$MISSING"
            echo ""
            echo "Please configure these in: Settings > Environments > ${{ inputs.environment }}"
            exit 1
          fi
          
          echo "All required secrets and variables are configured"

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup SSH
        uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd # v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Verify VPS connection
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          set -e
          
          echo "=== Testing SSH connection to VPS ==="
          
          if ! ssh $SSH_OPTS deploy@$VPS_HOST "echo 'SSH connection successful'"; then
            echo "ERROR: Failed to connect to VPS"
            echo "Please verify:"
            echo "  - VPS_HOST is correct: $VPS_HOST"
            echo "  - VPS_PORT is correct"
            echo "  - VPS_SSH_PRIVATE_KEY matches the deploy user's authorized_keys"
            echo "  - The VPS is reachable and SSH is running"
            exit 1
          fi
          
          echo "=== VPS connection verified ==="

      - name: Check if ~/app exists
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          set -e
          
          echo "=== Checking for existing deployment ==="
          
          if ! ssh $SSH_OPTS deploy@$VPS_HOST "[ -d ~/app ]"; then
            echo "ERROR: ~/app directory does not exist on the VPS!"
            echo ""
            echo "This workflow requires an existing deployment."
            echo "Please run the Deploy workflow first to perform initial deployment."
            exit 1
          fi
          
          echo "Existing deployment found - proceeding"

      - name: Verify Docker is available
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          set -e
          
          echo "=== Checking Docker availability ==="
          
          # Check Docker is installed
          if ! ssh $SSH_OPTS deploy@$VPS_HOST "docker --version"; then
            echo "ERROR: Docker is not installed on the VPS"
            echo "Please install Docker following the instructions in SETUP_VPS.md"
            exit 1
          fi
          
          # Check Docker daemon is running and accessible
          if ! ssh $SSH_OPTS deploy@$VPS_HOST "docker info > /dev/null 2>&1"; then
            echo "ERROR: Docker daemon is not running or not accessible"
            echo "Please ensure:"
            echo "  - Docker daemon is running"
            echo "  - The deploy user has permission to use Docker"
            echo "  - If using rootless Docker, it is properly configured"
            exit 1
          fi
          
          echo "Docker is available and running"

      - name: Pull Docker images
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          set -e
          
          echo "=== Pulling Docker images ==="
          
          ssh $SSH_OPTS deploy@$VPS_HOST << 'SCRIPT'
            set -e
            cd ~/app
            
            docker compose pull
          SCRIPT
          
          echo "=== Docker images pulled ==="

      - name: Recreate containers
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          set -e
          
          echo "=== Recreating containers ==="
          
          ssh $SSH_OPTS deploy@$VPS_HOST << 'SCRIPT'
            set -e
            cd ~/app
            
            docker compose up -d --force-recreate
            
            # Wait for services to start
            sleep 5
          SCRIPT
          
          echo "=== Containers recreated ==="

      - name: Clean unused images
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          set -e
          
          echo "=== Cleaning unused Docker images ==="
          
          ssh $SSH_OPTS deploy@$VPS_HOST "docker image prune -af"
          
          echo "=== Cleanup complete ==="

      - name: Show service status
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          DOMAIN: ${{ vars.DOMAIN }}
        run: |
          echo ""
          echo "=== Pull & Restart complete ==="
          echo ""
          
          # Show service status
          ssh $SSH_OPTS deploy@$VPS_HOST "cd ~/app && docker compose ps"
          
          echo ""
          echo "Application updated at: https://${DOMAIN}"

